<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KouriChat - 配置中心">
    <meta name="keywords" content="AI,KouriChat">
    <meta name="theme-color" content="#6366f1">
    <title>KouriChat - 配置中心</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdmirror.com/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/mom.ico">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-color: #f8fafc;  /* 统一背景颜色 */
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.8); /* 统一卡片背景 */
            --card-border: rgba(255, 255, 255, 0.5); /* 统一卡片边框 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* 统一卡片阴影 */
        }

        [data-bs-theme="dark"] {
            --primary-color: #818cf8;
            --secondary-color: #6366f1;
            --background-color: #0f172a;  /* 统一深色背景 */
            --text-color: #e2e8f0;
            --card-bg: rgba(30, 41, 59, 0.8); /* 统一深色卡片背景 */
            --card-border: rgba(255, 255, 255, 0.1); /* 统一深色卡片边框 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1); /* 统一深色卡片阴影 */
        }
        html,body{
            height:100%;
            margin: 0;
        }
        body {
            background: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .config-section {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
            animation-delay: 0.1s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 添加卡片微妙的装饰效果 */
        .config-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            opacity: 0.5;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--card-border) !important;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
            outline: none;
        }

        .form-label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .badge-info {
            background: var(--primary-color);
            cursor: pointer;
        }

        .theme-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .accordion-button {
            background: transparent;
            border: none;
        }

        .accordion-button:not(.collapsed) {
            background: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--primary-color);
        }

        .accordion-item {
            background: transparent;
            border-color: var(--card-border);
        }

        .toast {
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-check-label {
            margin-top: 0;
        }

        /* 人设选择下拉栏样式 */
        select[name="AVATAR_DIR"] {
            max-height: 300px;
            overflow-y: auto;
        }

        /* 添加导航栏样式，与dashboard.html保持一致 */
        .navbar {
            background: var(--card-bg) !important;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--card-border);
        }

        /* 输入框组样式 */
        .input-group {
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .input-group .form-control {
            border: none !important;
        }

        /* 配置项容器样式 */
        .config-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 响应式布局 */
        @media (max-width: 700px) {
            .config-section {
                padding: 1rem;
            }
        }

        /* 密码输入框样式 */
        .password-input-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        /* 修改左右两栏的间距 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;  /* 增加右边距 */
            }
            
            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;   /* 增加左边距 */
            }
        }

        /* 修改响应式布局下的间距 */
        @media (max-width: 767px) {
            .col-md-6 {
                margin-bottom: 2rem;  /* 增加上下间距 */
            }
            
            .config-section {
                margin-bottom: 0;  /* 移除原有的底部间距 */
            }
            
            /* 为了让背景更好地显示，增加内容区域的内边距 */
            main.container-fluid {
                padding: 2rem 1rem;  /* 调整移动端的内边距 */
            }
            
            /* 为底部保存按钮留出空间 */
            main.container-fluid {
                padding-bottom: 5rem;  /* 底部留出更多空间 */
            }
        }

        /* 优化桌面端布局 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;
            }
            
            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;
            }
            
            main.container-fluid {
                padding: 2rem;
                padding-bottom: 5rem;  /* 为底部保存按钮留出空间 */
            }
        }

        /* 修改主容器的内边距 */
        main.container-fluid {
            padding: 2rem;  /* 增加整体内边距 */
        }

        /* 添加相同的基础样式 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1 0 auto;
            width: 100%;
            padding: 2rem 0;
        }

        /* 添加通知动画 */
        .toast {
            transition: all 0.3s ease;
            transform: translateY(-20px);
            opacity: 0;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* 优化按钮悬停效果 */
        .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 添加输入框过渡效果 */
        #customApiInput {
            transition: all 0.3s ease;
        }

        #customApiInput.show {
            transform: translateY(0);
            opacity: 1;
        }

        #customApiInput.hide {
            transform: translateY(-10px);
            opacity: 0;
        }

        /* 添加通知容器样式 */
        .notification-container {
            z-index: 1050;
        }

        .accordion-button {
            background: transparent !important;
        }
        
        .accordion-button:not(.collapsed) {
            color: rgb(147, 151, 255) !important;
        }
        
        .list-group-item {
            border: none;
            margin-bottom: 8px;
            border-radius: 8px !important;
            transition: all 0.3s ease;
        }
        
        /* 只针对定时任务的列表项应用深色样式 */
        #schedule-settings .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }
        
        #schedule-settings .list-group-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            transform: translateX(5px);
        }
        
        /* 监听用户列表使用默认颜色 */
        #selected_users_LISTEN_LIST .list-group-item {
            background: var(--bs-list-group-bg);
            color: var(--bs-body-color);
        }
        
        /* 深色模式下的特定样式 */
        [data-bs-theme="dark"] #selected_users_LISTEN_LIST .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }
        
        /* 添加日期选择按钮组的响应式样式 */
        .btn-group.flex-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .btn-group.flex-wrap .btn {
            flex: 1 1 calc(14.28% - 0.25rem);
            min-width: 40px;
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
            text-align: center;
        }

        /* 在小屏幕上调整按钮大小 */
        @media (max-width: 768px) {
            .btn-group.flex-wrap .btn {
                flex: 1 1 calc(33.33% - 0.25rem);
                min-width: 30px;
                padding: 0.25rem 0.375rem;
                font-size: 0.75rem;
            }
        }

        /* 在更小的屏幕上进一步调整 */
        @media (max-width: 480px) {
            .btn-group.flex-wrap .btn {
                flex: 1 1 calc(50% - 0.25rem);
                min-width: 25px;
                padding: 0.25rem;
                font-size: 0.75rem;
            }
        }

        /* 全局温度滑块样式 */
        .temperature-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                rgb(13, 110, 253) 0%, 
                rgb(13, 202, 240) 50%, 
                rgb(253, 126, 20) 100%);
            outline: none;
            transition: opacity 0.2s;
        }
        
        .temperature-slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgb(13, 110, 253);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .temperature-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .temperature-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgb(13, 110, 253);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .temperature-value {
            transition: all 0.3s ease;
        }
        
        .temperature-value.updating {
            color: var(--primary-color);
            transform: scale(1.2);
        }
        
        /* 队列超时滑块样式 */
        .queue-timeout-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                rgb(253, 20, 20) 0%, 
                rgb(253, 126, 20) 40%, 
                rgb(13, 202, 240) 60%, 
                rgb(13, 110, 253) 100%);
            outline: none;
            transition: opacity 0.2s;
        }
        
        .queue-timeout-slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgb(13, 110, 253);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .queue-timeout-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .queue-timeout-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgb(13, 110, 253);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
    </style>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dark-mode.js"></script>
    
    <!-- 全局统一updateTemperature函数 - 处理所有温度滑块 -->
    <script>
    function updateTemperature(key, value) {
        // 将字符串转换为数字并保留一位小数
        const numValue = parseFloat(value).toFixed(1);
        
        // 更新显示值
        const displayElement = document.getElementById(key + '_display');
        if (displayElement) {
            displayElement.classList.add('updating');
            displayElement.textContent = numValue;
            setTimeout(() => {
                displayElement.classList.remove('updating');
            }, 300);
        }
        
        // 更新隐藏的实际提交值
        const inputElement = document.getElementById(key);
        if (inputElement) {
            inputElement.value = numValue;
            // 触发 change 事件以确保表单能捕获到值的变化
            const event = new Event('change', { bubbles: true });
            inputElement.dispatchEvent(event);
        }

        // 更新滑块位置（如果不是从滑块触发的事件）
        const sliderElement = document.getElementById(key + '_slider');
        if (sliderElement && sliderElement.value !== numValue) {
            sliderElement.value = numValue;
        }
        
        // 视觉反馈
        const container = inputElement?.closest('.mb-3') || displayElement?.closest('.mb-3');
        if (container) {
            container.style.transition = 'background-color 0.3s';
            container.style.backgroundColor = 'rgba(var(--bs-primary-rgb), 0.1)';
            setTimeout(() => {
                container.style.backgroundColor = '';
            }, 300);
        }
    }
    </script>
    
    <!-- 新增宏定义替代 config_item.html -->
    {% macro render_config_item(key, config) %}
<style>
    .form-label {
        transition: all 0.3s ease;
    }
    
    .form-label:hover {
        color: var(--primary-color);
    }
    
    .badge {
        transition: all 0.3s ease;
    }
    
    .badge:hover {
        transform: scale(1.1);
    }
    
    /* 列表项动画 */
    .list-group-item {
        transition: all 0.3s ease;
    }
    
    .list-group-item:hover {
        transform: translateX(5px);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    /* 按钮动画 */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    /* 输入框动画 */
    .form-control {
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
</style>
<label class="form-label">
    <span class="badge badge-info rounded-pill me-2" 
        data-bs-toggle="tooltip" 
        title="{{ key }}">
        <i class="bi bi-info-circle"></i>
    </span>
    {{ config.description }}
</label>
{% if key == 'LISTEN_LIST' %}
    <div class="mb-2">
        <div class="input-group mb-2">
            <input type="text" class="form-control" 
                id="input_{{ key }}" 
                placeholder="请输入要监听的用户">
            <button class="btn btn-primary" type="button" 
                onclick="addNewUser('{{ key }}')"
                title="添加用户">
                添加 <i class="bi bi-plus-lg"></i>
            </button>
        </div>
        <div id="selected_users_{{ key }}" class="list-group">
            {% if config.value %}
                {% for user in config.value %}
                    {% if user %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            {{ user }}
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('{{ key }}', '{{ user }}')" title="删除用户">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <input type="text" class="form-control" 
        id="{{ key }}" name="{{ key }}" 
        value="{{ config.value|join(',') }}"
        placeholder="多个值用英文逗号分隔"
        readonly
        style="display: none;">
{% elif key == 'DEEPSEEK_BASE_URL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="api_provider_select" onchange="updateApiProvider(this.value)" aria-label="选择API提供商">
            <!-- 移除请选择服务提供商选项 -->
            <!-- 预设常用选项，减少依赖异步加载 -->
            <option value="kourichat-asia" data-url="https://api.kourichat.com/v1" data-register="https://api.kourichat.com/register">KouriChat API </option>
            <option value="siliconflow" data-url="https://api.siliconflow.cn/v1/" data-register="https://www.siliconflow.cn">硅基流动 API</option>
            <option value="deepseek" data-url="https://api.deepseek.com/v1" data-register="https://platform.deepseek.com">DeepSeek API</option>
            <option value="ollama" data-url="http://localhost:11434/api/chat" data-register="https://ollama.ai">本地 Ollama</option>
            <option value="custom">自定义API提供商</option>
        </select>

        <!-- 添加自定义 API 输入框 -->
        <div id="customApiInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                   placeholder="请输入自定义 API 地址"
                   onchange="updateCustomApi(this.value)">
        </div>

        <!-- 注册链接容器 -->
        <div id="register_links" class="d-none">
            <!-- 注册链接将通过JavaScript动态添加 -->
        </div>

        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            readonly
            style="display: none;">
    </div>

    <script>
    let modelConfigs = null;
    
    // 获取配置数据 - 添加超时控制
    async function fetchModelConfigs() {
        try {
            // 设置一个2秒的超时
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            
            const response = await fetch('/get_model_configs', {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            modelConfigs = data;
            // 只更新模型列表，不更新提供商列表
            updateModelSelectsFromConfig();
        } catch (error) {
            console.error('获取配置失败或超时:', error);
            // 发生错误或超时时，仍然设置初始值
            setInitialValues();
        }
    }

    // 设置初始值
    function setInitialValues() {
        // 根据当前配置设置初始值
        const currentUrl = document.getElementById('DEEPSEEK_BASE_URL').value;
        const apiSelect = document.getElementById('api_provider_select');
        const currentModel = document.getElementById('MODEL').value;
        const hiddenInput = document.querySelector(`input[name="DEEPSEEK_BASE_URL"]`);
        
        // 查找匹配的选项
        let found = false;
        for (let i = 0; i < apiSelect.options.length; i++) {
            const option = apiSelect.options[i];
            if (option.dataset.url === currentUrl) {
                apiSelect.value = option.value;
                updateApiProvider(option.value);
                found = true;
                break;
            }
        }
        
        // 如果没有找到匹配项，使用自定义选项
        if (!found && currentUrl) {
            apiSelect.value = 'custom';
            showCustomApiInput(currentUrl);
            
            // 对于自定义API提供商，显示自定义模型输入框并设置值
            const customModelInput = document.getElementById('customModelInput');
            if (customModelInput && currentModel) {
                customModelInput.style.display = 'block';
                customModelInput.querySelector('input').value = currentModel;
                
                // 设置模型选择框
                const modelSelect = document.getElementById('model_select');
                if (modelSelect) {
                    // 添加自定义选项
                    if (!modelSelect.querySelector('option[value="custom"]')) {
                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                    }
                    modelSelect.value = 'custom';
                }
            }
            
            // 自定义模式下更新模型选择
            updateModelSelect('custom');
        }
        
        // 确保隐藏输入框的值与显示值一致
        if (hiddenInput) {
            hiddenInput.value = currentUrl;
        }
    }
    
    // 从配置更新模型列表
    function updateModelSelectsFromConfig() {
        if (!modelConfigs) return;
        
        // 获取当前选择的提供商
        const apiSelect = document.getElementById('api_provider_select');
        if (apiSelect.value) {
            updateModelSelect(apiSelect.value);
        }
    }

    // 显示自定义API输入框
    function showCustomApiInput(value = '') {
        const customApiInput = document.getElementById('customApiInput');
        const hiddenInput = document.querySelector(`input[name="DEEPSEEK_BASE_URL"]`);
        customApiInput.style.display = 'block';
        if (value) {
            const input = customApiInput.querySelector('input');
            input.value = value;
            // 同时更新隐藏输入框
            if (hiddenInput) {
                hiddenInput.value = value;
            }
        }
    }

    // 更新API提供商
    function updateApiProvider(value) {
        const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
        const customApiInput = document.getElementById('customApiInput');
        const registerLinks = document.getElementById('register_links');
        const hiddenInput = document.querySelector(`input[name="DEEPSEEK_BASE_URL"]`);

        // 重置所有状态
        customApiInput.style.display = 'none';
        registerLinks.classList.add('d-none');
        registerLinks.innerHTML = '';

        // 处理自定义选项
        if (value === 'custom') {
            showCustomApiInput();
            updateModelSelect('custom');
            return;
        }

        // 处理未选择情况
        if (!value) {
            updateModelSelect('');
            return;
        }

        // 获取选中的提供商配置
        const selectedOption = document.querySelector(`#api_provider_select option[value="${value}"]`);
        if (!selectedOption) return;

        // 更新API URL
        const apiUrl = selectedOption.dataset.url;
        baseUrlInput.value = apiUrl;
        // 同时更新隐藏输入框
        if (hiddenInput) {
            hiddenInput.value = apiUrl;
        }
        
        // 添加标记是否为 Ollama
        if (value === 'ollama') {
            baseUrlInput.dataset.isOllama = 'true';
        } else {
            baseUrlInput.dataset.isOllama = 'false';
        }

        // 创建注册按钮
        const registerUrl = selectedOption.dataset.register;
        if (registerUrl) {
            const link = document.createElement('a');
            link.href = registerUrl;
            link.className = 'btn btn-outline-primary w-100';
            link.target = '_blank';
            link.innerHTML = `<i class="bi bi-box-arrow-up-right me-1"></i>前往${selectedOption.textContent.replace(' API', '')}注册`;
            registerLinks.innerHTML = '';
            registerLinks.appendChild(link);
            registerLinks.classList.remove('d-none');
        }

        // 更新模型选择框
        updateModelSelect(value);
    }

    // 更新自定义API
    function updateCustomApi(value) {
        const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
        const hiddenInput = document.querySelector(`input[name="DEEPSEEK_BASE_URL"]`);
        if (value) {
            baseUrlInput.value = value;
            // 同时更新隐藏输入框
            if (hiddenInput) {
                hiddenInput.value = value;
            }
        }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 立即设置初始值，不等待异步请求
        setInitialValues();
        // 然后异步获取完整配置
        fetchModelConfigs();
    });
    </script>
{% elif key == 'PROMPT_ENHANCEMENT' %}
    <select class="form-select" id="{{ key }}" name="{{ key }}">
        <option value="True" {% if config.value %}selected{% endif %}>启用</option>
        <option value="False" {% if not config.value %}selected{% endif %}>停用</option>
    </select>
{% elif key == 'AVATAR_DIR' %}
    <select class="form-select" id="{{ key }}" name="{{ key }}">
        {% for option in config.options %}
        <option value="{{ option }}" {% if option == config.value %}selected{% endif %}>
            {{ option.split('/')[-1] }}
        </option>
        {% endfor %}
    </select>
{% elif config.value is boolean %}
    <div class="form-check form-switch d-flex align-items-center" style="padding: 6px 0; min-height: 38px;">
        <input class="form-check-input me-2" type="checkbox" role="switch" 
            id="{{ key }}" name="{{ key }}" 
            {% if config.value %}checked{% endif %}
            style="margin: 0;">
        <label class="form-check-label mb-0" for="{{ key }}" style="line-height: 24px;">
            {{ '启用' if config.value else '停用' }}
        </label>
    </div>
{% elif key == 'MODEL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="model_select" onchange="updateModel(this.value)" aria-label="选择模型">
            <!-- 移除请选择模型选项 -->
        </select>

        <!-- 添加自定义模型输入框 -->
        <div id="customModelInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                   placeholder="请输入自定义模型名称"
                   onchange="updateCustomModel(this.value)"
                   value="{{ config.value if not config.value in ['deepseek-ai/DeepSeek-V3', 'deepseek-ai/DeepSeek-R1', 'Pro/deepseek-ai/DeepSeek-V3', 'Pro/deepseek-ai/DeepSeek-R1', 'deepseek-chat', 'deepseek-reasoner'] else '' }}">
        </div>

        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            readonly
            style="display: none;">
    </div>
    
    <script>
    // 初始化模型选择框 - 直接显示当前模型，不依赖API调用
    function initializeModelSelect() {
        const modelSelect = document.getElementById('model_select');
        const modelInput = document.getElementById('MODEL');
        const currentModel = modelInput.value;
        const customModelInput = document.getElementById('customModelInput');
        
        // 预设一些常用模型选项，确保始终有这些选项
        const defaultModels = [
            {id: 'kourichat-v3', name: 'KouriChat V3'},
            {id: 'deepseek-ai/DeepSeek-V3', name: 'DeepSeek V3'},
            {id: 'Pro/deepseek-ai/DeepSeek-V3', name: 'DeepSeek V3 Pro'},
            {id: 'Pro/deepseek-ai/DeepSeek-R1', name: 'DeepSeek R1 Pro'},
            {id: 'deepseek-chat', name: 'DeepSeek Chat'},
            {id: 'deepseek-reasoner', name: 'DeepSeek Reasoner'}
        ];
        
        // 添加默认模型选项
        defaultModels.forEach(model => {
            if (!modelSelect.querySelector(`option[value="${model.id}"]`)) {
                modelSelect.innerHTML += `<option value="${model.id}">${model.name}</option>`;
            }
        });
        
        // 确保选择框始终包含自定义选项
        if (!modelSelect.querySelector('option[value="custom"]')) {
            modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
        }
        
        // 如果有当前值，且不是已知的预定义模型，显示为自定义模型
        if (currentModel) {
            // 检查当前值是否在选择框中已存在
            const existingOption = Array.from(modelSelect.options).find(opt => opt.value === currentModel);
            
            if (!existingOption) {
                // 如果不存在，设置为自定义模型
                modelSelect.value = 'custom';
                if (customModelInput) {
                    customModelInput.style.display = 'block';
                    customModelInput.querySelector('input').value = currentModel;
                }
            } else {
                // 如果存在，选中它
                modelSelect.value = currentModel;
                // 确保自定义输入框隐藏
                if (customModelInput) {
                    customModelInput.style.display = 'none';
                }
            }
        }
    }
    
    // 更新模型选择框
    async function updateModelSelect(providerId) {
        const modelSelect = document.getElementById('model_select');
        const modelInput = document.getElementById('MODEL');
        const customModelInput = document.getElementById('customModelInput');
        
        // 保存当前模型值，确保后续操作不会丢失
        const currentModelValue = modelInput.value;
        
        // 重置选择框 - 移除"请选择模型"选项
        modelSelect.innerHTML = '';

        if (providerId === 'custom') {
            modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
            modelSelect.value = 'custom';
            
            // 显示自定义输入框并设置当前值
            customModelInput.style.display = 'block';
            customModelInput.querySelector('input').value = currentModelValue;
            return;
        }

        if (!providerId) return;

        // 保存当前选中的模型，以便后面恢复
        const currentModel = modelInput.value;
        
        try {
            // 加载该提供商下的模型列表
            let models = [];
            
            // 如果已缓存配置数据
            if (modelConfigs && modelConfigs.models && modelConfigs.models[providerId]) {
                models = modelConfigs.models[providerId];
            } else {
                // 尝试从服务器加载
                try {
                    const response = await fetch(`/get_model_configs?provider=${providerId}`);
                    const data = await response.json();
                    if (data.status === 'success' && data.models && data.models[providerId]) {
                        models = data.models[providerId];
                    }
                } catch (e) {
                    console.error('获取模型列表失败:', e);
                }
            }
            
            // 添加模型选项
            if (models.length) {
                models.forEach(model => {
                    // 检查是否已存在该选项
                    if (!modelSelect.querySelector(`option[value="${model.id}"]`)) {
                        modelSelect.innerHTML += `
                            <option value="${model.id}" 
                                ${model.recommended ? 'data-recommended="true"' : ''}
                                ${model.context_length ? 'data-context="' + model.context_length + '"' : ''}>
                                ${model.name} ${model.recommended ? '(推荐)' : ''}
                            </option>`;
                    }
                });
            }
            
            // 添加自定义模型选项 - 无论选择哪个供应商都添加
            modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
            
        } catch (error) {
            console.error('更新模型选项失败:', error);
        } finally {
            // 检查当前值是否存在于模型列表中
            const modelExists = Array.from(modelSelect.options).some(opt => opt.value === currentModelValue);
            
            if (modelExists) {
                // 如果当前值是预设模型之一
                modelSelect.value = currentModelValue;
                customModelInput.style.display = 'none';
            } else if (currentModelValue) {
                // 如果当前值不在预设列表中且不为空，视为自定义模型
                // 添加自定义选项到下拉列表
                modelSelect.value = 'custom';
                
                // 显示自定义输入框并设置值
                customModelInput.style.display = 'block';
                customModelInput.querySelector('input').value = currentModelValue;
                
                // 确保隐藏输入框的值是自定义的值
                modelInput.value = currentModelValue;
            } else if (modelSelect.options.length > 1) {
                // 如果没有当前模型值，自动选择推荐模型或第一个选项
                const recommendedOption = Array.from(modelSelect.options).find(opt => 
                    opt.textContent.includes('推荐') || 
                    opt.getAttribute('data-recommended') === 'true'
                );
                
                if (recommendedOption) {
                    modelSelect.value = recommendedOption.value;
                } else {
                    // 如果没有推荐模型，选择第一个有效选项
                    modelSelect.selectedIndex = 0;
                }
                
                // 更新隐藏的值
                const selectedModel = modelSelect.value;
                modelInput.value = selectedModel;
                // 确保自定义输入框隐藏
                customModelInput.style.display = 'none';
            }
        }
    }

    // 更新模型
    function updateModel(value) {
        const modelInput = document.getElementById('MODEL');
        const customModelInput = document.getElementById('customModelInput');
        
        if (value === 'custom') {
            customModelInput.style.display = 'block';
            customModelInput.querySelector('input').focus();
        } else {
            customModelInput.style.display = 'none';
            if (value) {
                modelInput.value = value;
            }
        }
    }

    // 更新自定义模型
    function updateCustomModel(value) {
        const modelInput = document.getElementById('MODEL');
        if (value) {
            modelInput.value = value;
        }
    }

    // 页面加载时获取配置
    document.addEventListener('DOMContentLoaded', function() {
        // 首先初始化模型选择框，确保当前模型值能正确显示
        initializeModelSelect();
        // 然后获取更多模型配置数据（如果可用）
        fetchModelConfigs();
    });
    </script>
{% elif key == 'TEMPERATURE' %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>当前值: <strong id="{{ key }}_display" class="temperature-value">{{ config.value }}</strong></span>
            <span class="badge bg-primary">创造性参数</span>
        </div>
        <input type="range" id="{{ key }}_slider"
            class="temperature-slider"
            min="{{ config.min|default(0) }}"
            max="{{ config.max|default(2) }}"
            step="0.1"
            value="{{ config.value }}"
            oninput="updateTemperature('{{ key }}', this.value)">
        <div class="d-flex justify-content-between mt-1">
            <span class="small text-muted">低温 (更确定)</span>
            <span class="small text-muted">高温 (更创意)</span>
        </div>
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
    </div>

    <script>
        // 确保页面加载时初始化温度值
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('{{ key }}_slider');
            if (slider) {
                updateTemperature('{{ key }}', slider.value);
            }
        });
    </script>
{% elif key == 'VISION_BASE_URL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="vision_api_provider_select" onchange="updateVisionApiProvider(this.value)" aria-label="选择图像识别API提供商">
            <!-- 移除请选择服务提供商选项 -->
            <!-- 预设常用选项，减少依赖异步加载 -->
            <option value="kourichat-asia" data-url="https://api.kourichat.com/v1" data-register="https://api.kourichat.com/register">KouriChat API </option>
            <option value="moonshot" data-url="https://api.moonshot.cn/v1" data-register="https://platform.moonshot.cn/console/api-keys">Moonshot AI</option>
            <option value="openai" data-url="https://api.openai.com/v1" data-register="https://platform.openai.com/api-keys">OpenAI</option>
            <option value="custom">自定义服务提供商</option>
        </select>

        <!-- 添加自定义 API 输入框 -->
        <div id="customVisionApiInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                   placeholder="请输入自定义服务地址"
                   onchange="updateCustomVisionApi(this.value)">
        </div>

        <!-- 注册链接容器 -->
        <div id="vision_register_links" class="d-none">
            <!-- 注册链接将通过JavaScript动态添加 -->
        </div>

        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            readonly
            style="display: none;">
    </div>

    <script>
    let visionModelConfigs = {
        api_providers: [
            {
                id: "kourichat-asia",
                name: "KouriChat API (推荐)",
                url: "https://api.kourichat.com/v1",
                register_url: "https://api.kourichat.com/register"
            },
            {
                id: "moonshot",
                name: "Moonshot AI",
                url: "https://api.moonshot.cn/v1",
                register_url: "https://platform.moonshot.cn/console/api-keys"
            },
            {
                id: "openai",
                name: "OpenAI",
                url: "https://api.openai.com/v1",
                register_url: "https://platform.openai.com/api-keys"
            }
        ],
        models: {
            "kourichat-asia": [
                {id: "kourichat-vision", name: "KouriChat Vision (推荐)"},
                {id: "gemini-2.5-pro", name: "Gemini 2.5 Pro"},
                {id: "gpt-4o", name: "GPT-4o"}
            ],
            "moonshot": [
                {id: "moonshot-v1-8k-vision-preview", name: "Moonshot V1 8K Vision (推荐)"},
                {id: "moonshot-v1-32k-vision", name: "Moonshot V1 32K Vision"}
            ],
            "openai": [
                {id: "gpt-4o", name: "GPT-4o (推荐)"},
                {id: "gpt-4-vision-preview", name: "GPT-4 Vision"}
            ]
        }
    };
    
    // 获取配置数据 - 添加超时控制，但优先使用预设数据
    async function fetchVisionModelConfigs() {
        try {
            // 设置一个2秒的超时
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            
            const response = await fetch('/get_vision_api_configs', {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // 合并服务器返回的数据到本地预设数据
                data.api_providers.forEach(provider => {
                    // 检查是否已存在相同ID的提供商
                    const existingIndex = visionModelConfigs.api_providers.findIndex(p => p.id === provider.id);
                    if (existingIndex >= 0) {
                        // 更新现有提供商
                        visionModelConfigs.api_providers[existingIndex] = provider;
                    } else {
                        // 添加新提供商
                        visionModelConfigs.api_providers.push(provider);
                    }
                });
                
                // 合并模型数据
                Object.keys(data.models || {}).forEach(providerId => {
                    visionModelConfigs.models[providerId] = data.models[providerId];
                });
            }
        } catch (error) {
            console.error('获取图像识别配置失败或超时:', error);
        } finally {
            // 无论成功失败都初始化选择框
            setVisionInitialValues();
        }
    }

    // 设置初始值
    function setVisionInitialValues() {
        // 根据当前配置设置初始值
        const currentUrl = document.getElementById('VISION_BASE_URL').value;
        const apiSelect = document.getElementById('vision_api_provider_select');
        const currentModel = document.getElementById('VISION_MODEL').value;
        
        // 查找匹配的选项
        let found = false;
        for (let i = 0; i < apiSelect.options.length; i++) {
            const option = apiSelect.options[i];
            if (option.dataset.url === currentUrl) {
                apiSelect.value = option.value;
                updateVisionApiProvider(option.value);
                found = true;
                break;
            }
        }
        
        // 如果没有找到匹配项，使用自定义选项
        if (!found && currentUrl) {
            apiSelect.value = 'custom';
            showCustomVisionApiInput(currentUrl);
            
            // 对于自定义API提供商，显示自定义模型输入框并设置值
            const customModelInput = document.getElementById('customVisionModelInput');
            if (customModelInput && currentModel) {
                customModelInput.style.display = 'block';
                customModelInput.querySelector('input').value = currentModel;
                
                // 设置模型选择框
                const modelSelect = document.getElementById('vision_model_select');
                if (modelSelect) {
                    // 添加自定义选项
                    if (!modelSelect.querySelector('option[value="custom"]')) {
                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                    }
                    modelSelect.value = 'custom';
                }
            }
            
            updateVisionModelSelect('custom');
        }
        
        // 如果自定义模型输入框需要显示
        const customModelInput = document.getElementById('customVisionModelInput');
        if (apiSelect.value === 'custom' && customModelInput && currentModel) {
            customModelInput.style.display = 'block';
            customModelInput.querySelector('input').value = currentModel;
        }
    }

    // 显示自定义图像识别API输入框
    function showCustomVisionApiInput(value = '') {
        const customApiInput = document.getElementById('customVisionApiInput');
        customApiInput.style.display = 'block';
        if (value) {
            customApiInput.querySelector('input').value = value;
        }
    }

    // 更新自定义图像识别API
    function updateCustomVisionApi(value) {
        const baseUrlInput = document.getElementById('VISION_BASE_URL');
        if (value) {
            baseUrlInput.value = value;
        }
    }

    // 更新图像识别API提供商
    function updateVisionApiProvider(value) {
        const baseUrlInput = document.getElementById('VISION_BASE_URL');
        const customApiInput = document.getElementById('customVisionApiInput');
        const registerLinks = document.getElementById('vision_register_links');

        // 重置所有状态
        customApiInput.style.display = 'none';
        registerLinks.classList.add('d-none');
        registerLinks.innerHTML = '';

        // 处理自定义选项
        if (value === 'custom') {
            showCustomVisionApiInput();
            updateVisionModelSelect('custom');
            return;
        }

        // 处理未选择情况
        if (!value) {
            updateVisionModelSelect('');
            return;
        }

        // 获取选中的提供商配置
        const selectedOption = document.querySelector(`#vision_api_provider_select option[value="${value}"]`);
        if (!selectedOption) return;

        // 更新API URL
        const apiUrl = selectedOption.dataset.url;
        baseUrlInput.value = apiUrl;

        // 创建注册按钮
        const registerUrl = selectedOption.dataset.register;
        if (registerUrl) {
            const link = document.createElement('a');
            link.href = registerUrl;
            link.className = 'btn btn-outline-primary w-100';
            link.target = '_blank';
            link.innerHTML = `<i class="bi bi-box-arrow-up-right me-1"></i>前往${selectedOption.textContent.replace(' (推荐)', '').replace(' API', '')}注册`;
            registerLinks.innerHTML = '';
            registerLinks.appendChild(link);
            registerLinks.classList.remove('d-none');
        }

        // 更新模型选择框
        updateVisionModelSelect(value);
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 立即设置初始值，不等待异步请求
        setVisionInitialValues();
        // 然后异步获取更多配置
        fetchVisionModelConfigs();
    });
    </script>

{% elif key == 'VISION_API_KEY' %}
    <div class="mb-3">
        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            placeholder="请输入API密钥">
        <div id="api_key_help" class="mt-2">
            <p class="small text-muted">API密钥用于访问图像识别服务，请在选择的服务提供商官网获取</p>
        </div>
    </div>

{% elif key == 'VISION_MODEL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="vision_model_select" onchange="updateVisionModel(this.value)" aria-label="选择图像识别模型">
            <!-- 移除请选择模型选项 -->
        </select>

        <!-- 添加自定义模型输入框 -->
        <div id="customVisionModelInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                   placeholder="请输入自定义模型名称"
                   onchange="updateCustomVisionModel(this.value)">
        </div>

        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            readonly
            style="display: none;">
    </div>
    
    <script>
    // 更新图像识别模型选择框
    function updateVisionModelSelect(providerId) {
        const modelSelect = document.getElementById('vision_model_select');
        const modelInput = document.getElementById('VISION_MODEL');
        const customModelInput = document.getElementById('customVisionModelInput');
        
        // 保存当前模型值，确保后续操作不会丢失
        const currentModelValue = modelInput.value;
        
        // 重置选择框 - 移除"请选择模型"选项
        modelSelect.innerHTML = '';
        customModelInput.style.display = 'none';
        
        // 预设一些常用模型选项，确保始终有这些选项
        const defaultModels = {
            "kourichat-asia": [
                {id: "kourichat-vision", name: "KouriChat Vision (推荐)"}
            ],
            "moonshot": [
                {id: "moonshot-v1-8k-vision-preview", name: "Moonshot V1 8K Vision (推荐)"},
                {id: "moonshot-v1-32k-vision", name: "Moonshot V1 32K Vision"}
            ],
            "openai": [
                {id: "gpt-4o", name: "GPT-4o (推荐)"},
                {id: "gpt-4-vision-preview", name: "GPT-4 Vision"}
            ]
        };
        
        // 如果是自定义提供商或没有选择提供商
        if (providerId === 'custom' || !providerId) {
            if (providerId === 'custom') {
                // 添加自定义选项
                modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                modelSelect.value = 'custom';
                modelSelect.disabled = false;
                
                // 显示自定义输入框并设置当前值
                customModelInput.style.display = 'block';
                customModelInput.querySelector('input').value = currentModelValue;
            } else {
                modelSelect.disabled = true;
            }
            return;
        }
        
        // 启用选择框
        modelSelect.disabled = false;
        
        // 获取提供商对应的模型列表
        let models = [];
        if (visionModelConfigs && visionModelConfigs.models && visionModelConfigs.models[providerId]) {
            models = visionModelConfigs.models[providerId];
        } else if (defaultModels[providerId]) {
            models = defaultModels[providerId];
        }
        
        // 添加模型选项
        models.forEach(model => {
            modelSelect.innerHTML += `<option value="${model.id}">${model.name}</option>`;
        });
        
        // 添加自定义模型选项 - 无论选择哪个供应商都添加
        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
        
        // 检查当前值是否存在于模型列表中
        const modelExists = models.some(m => m.id === currentModelValue);
        
        if (modelExists) {
            // 如果当前值是预设模型之一
            modelSelect.value = currentModelValue;
            customModelInput.style.display = 'none';
        } else if (currentModelValue) {
            // 如果当前值不在预设列表中且不为空，视为自定义模型
            // 添加自定义选项到下拉列表
            modelSelect.value = 'custom';
            
            // 显示自定义输入框并设置值
            customModelInput.style.display = 'block';
            customModelInput.querySelector('input').value = currentModelValue;
            
            // 确保隐藏输入框的值是自定义的值
            modelInput.value = currentModelValue;
        } else if (models.length > 0) {
            // 默认选择第一个推荐模型
            const recommendedModel = models.find(m => m.name.includes('推荐'));
            if (recommendedModel) {
                modelSelect.value = recommendedModel.id;
                modelInput.value = recommendedModel.id;
            } else {
                // 没有推荐模型，选择第一个
                modelSelect.value = models[0].id;
                modelInput.value = models[0].id;
            }
            // 确保自定义输入框隐藏
            customModelInput.style.display = 'none';
        }
    }
    
    // 更新选中的图像识别模型
    function updateVisionModel(value) {
        const modelInput = document.getElementById('VISION_MODEL');
        const customModelInput = document.getElementById('customVisionModelInput');
        
        if (value === 'custom') {
            customModelInput.style.display = 'block';
            customModelInput.querySelector('input').focus();
        } else {
            customModelInput.style.display = 'none';
            if (value) {
                modelInput.value = value;
            }
        }
    }
    
    // 更新自定义图像识别模型
    function updateCustomVisionModel(value) {
        const modelInput = document.getElementById('VISION_MODEL');
        if (value) {
            modelInput.value = value;
        }
    }
    </script>
{% elif key == 'VISION_TEMPERATURE' %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>当前值: <strong id="{{ key }}_display" class="temperature-value">{{ config.value }}</strong></span>
            <span class="badge bg-primary">创造性参数</span>
        </div>
        <input type="range" id="{{ key }}_slider"
            class="temperature-slider"
            min="{{ config.min|default(0) }}"
            max="{{ config.max|default(1) }}"
            step="0.1"
            value="{{ config.value }}"
            oninput="updateTemperature('{{ key }}', this.value)">
        <div class="d-flex justify-content-between mt-1">
            <span class="small text-muted">低温 (更确定)</span>
            <span class="small text-muted">高温 (更创意)</span>
        </div>
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
    </div>

    <script>
        // 确保页面加载时初始化温度值
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('{{ key }}_slider');
            if (slider) {
                updateTemperature('{{ key }}', slider.value);
            }
        });
    </script>
{% elif key == 'QUEUE_TIMEOUT' %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>当前值: <strong id="{{ key }}_display">{{ config.value }}</strong></span>
            <span class="badge bg-primary">响应速度</span>
        </div>
        <input type="range" id="{{ key }}_slider"
            class="queue-timeout-slider"
            min="0"
            max="{{ config.max }}"
            step="{{ config.step|default(1) }}"
            value="{{ config.value }}"
            oninput="updateRangeValue('{{ key }}', this.value)">
        <div class="d-flex justify-content-between mt-1">
            <span class="small text-muted">快速响应 (0)</span>
            <span class="small text-muted">慢速响应 ({{ config.max }})</span>
        </div>
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
        <div class="mt-2 small text-muted">
            <i class="bi bi-info-circle me-1"></i>注意！时间小于8秒会提高封号风险！！！如果在短时间内喜欢多段发送内容，或者打字速度较慢，建议可以设置更大数值
        </div>
    </div>

    <script>
        // 确保页面加载时初始化滑块值
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('{{ key }}_slider');
            if (slider) {
                updateRangeValue('{{ key }}', slider.value);
            }
        });
    </script>
{% elif config.type == 'number' and config.min is defined and config.max is defined %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>当前值: <strong id="{{ key }}_display">{{ config.value }}</strong></span>
        </div>
        <input type="range" id="{{ key }}_slider"
            class="form-range"
            min="{{ config.min }}"
            max="{{ config.max }}"
            step="{{ config.step|default(1) }}"
            value="{{ config.value }}"
            oninput="updateRangeValue('{{ key }}', this.value)">
        <div class="d-flex justify-content-between mt-1">
            <span class="small text-muted">{{ config.min }}</span>
            <span class="small text-muted">{{ config.max }}</span>
        </div>
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
    </div>

    <script>
        // 确保页面加载时初始化滑块值
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('{{ key }}_slider');
            if (slider) {
                updateRangeValue('{{ key }}', slider.value);
            }
        });
    </script>
{% else %}
    <input type="text" class="form-control" 
        id="{{ key }}" name="{{ key }}" 
        value="{{ config.value }}">
{% endif %}
    {% endmacro %}
    
    <!-- 添加全局脚本处理滑块控件 -->
    <script>
        // 更新数值滑块的值
        function updateRangeValue(key, value) {
            const display = document.getElementById(`${key}_display`);
            const input = document.getElementById(key);
            if (display) {
                display.textContent = value;
            }
            if (input) {
                input.value = value;
            }
        }
    </script>
</head>
<body>
    {% include 'navbar.html' %}
    
    <main class="container-fluid py-4">
        <div class="row">
            <!-- 左侧基础配置 -->
            <div class="col-md-6 pe-md-2">
                <div class="config-section h-100">
                    <h4 class="mb-4">
                        <i class="bi bi-gear-fill me-2"></i>基础配置
                        <div class="float-end">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="exportConfigBtn">
                                <i class="bi bi-upload me-1"></i>导出配置
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="importConfigBtn">
                                <i class="bi bi-download me-1"></i>导入配置
                            </button>
                        </div>
                    </h4>
                    <form id="configForm">
                        {% for group_name, configs in config_groups.items() %}
                            {% if group_name == '基础配置' %}
                            <div class="accordion mb-3">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                            {{ group_name }}
                                        </button>
                                    </h2>
                                    <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse show">
                                        <div class="accordion-body">
                                            {% for key, config in configs.items() %}
                                            <div class="mb-4">
                                                {{ render_config_item(key, config) }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>

            <!-- 右侧其他配置 -->
            <div class="col-md-6 ps-md-2">
                <div class="config-section h-100">
                    <h4 class="mb-4">
                        <i class="bi bi-sliders me-2"></i>高级配置
                    </h4>
                    <form id="otherConfigForm">
                        {% for group_name, configs in config_groups.items() %}
                            {% if group_name != '基础配置' and group_name != '定时任务配置' %}  {# 排除定时任务配置 #}
                            <div class="accordion mb-3">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                            {{ group_name }}
                                        </button>
                                    </h2>
                                    <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            {% for key, config in configs.items() %}
                                            <div class="mb-4">
                                                {{ render_config_item(key, config) }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}

                        <!-- 单独添加定时任务配置部分 -->
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#schedule-settings">
                                        定时任务配置
                                    </button>
                                </h2>
                                <div id="schedule-settings" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <!-- 定时任务配置的内容 -->
                                        <input type="hidden" 
                                               id="TASKS" 
                                               name="TASKS" 
                                               value='{{ tasks_json|safe }}'>
                                        
                                        <!-- 添加和管理任务的按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action" 
                                               data-bs-toggle="modal" data-bs-target="#addTaskModal">
                                                <i class="bi bi-plus-lg me-2"></i>
                                                添加定时任务
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>
                                        
                                        <!-- 任务列表管理按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action" 
                                               data-bs-toggle="modal" data-bs-target="#taskListModal">
                                                <i class="bi bi-list-ul me-2"></i>
                                                任务列表管理
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>
                                        
                                        <!-- 说明文字 -->
                                        <div class="text-muted small">
                                            <i class="bi bi-info-circle me-1"></i>
                                            可以添加定时发送消息的任务，支持Cron表达式和时间间隔两种方式
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>

        <!-- 保存按钮固定在底部 -->
        <div class="position-fixed bottom-0 start-0 w-100 bg-body p-3 shadow-lg">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <button type="button" 
                            class="btn btn-primary btn-lg w-100" 
                            id="saveButton">
                            <i class="bi bi-save me-2"></i>保存所有设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-container">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                <span class="toast-message"></span>
            </div>
        </div>
    </div>

    <!-- 在 body 标签下添加顶部通知区域 -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3 notification-container">
        <div id="saveNotification" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span id="saveNotificationMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭通知"></button>
            </div>
        </div>
    </div>

    <!-- 监听用户列表为空的确认对话框 -->
    <div class="modal fade" id="emptyListenListModal" tabindex="-1" aria-labelledby="emptyListenListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emptyListenListModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>提示
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <p>您未填写监听用户，是否继续保存？</p>
                    <p class="text-muted small">未填写监听用户将导致机器人无法响应任何消息。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">否</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveBtn">是</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 人设选择提醒对话框 -->
    <div class="modal fade" id="avatarReminderModal" tabindex="-1" aria-labelledby="avatarReminderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarReminderModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>人设提醒
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <p>您选择的人设是：<span id="selectedAvatarName" class="fw-bold"></span></p>
                    <p class="text-muted small">请确认这是您要使用的人设。如需修改人设内容，请前往"角色设定"页面。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAvatarBtn">确认并保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务列表模态框 -->
    <div class="modal fade" id="taskListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-list-check me-2"></i>定时任务列表
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="taskListContainer" class="list-group">
                        <!-- 默认显示无任务提示 -->
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox fs-2"></i>
                            <p class="mt-2">暂无定时任务</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加任务模态框 -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>添加定时任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="row">
                            <!-- 左侧：基本信息 -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-key me-2"></i>任务ID
                                    </label>
                                    <input type="text" class="form-control" id="taskId" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-person me-2"></i>发送对象
                                    </label>
                                    <select class="form-select" id="taskChatId" required>
                                        <option value="">请选择发送对象</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-chat-text me-2"></i>消息内容
                                    </label>
                                    <textarea class="form-control" id="taskContent" rows="3" required></textarea>
                                </div>
                            </div>
                            
                            <!-- 右侧：定时设置 -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-alarm me-2"></i>定时类型
                                    </label>
                                    <select class="form-select" id="scheduleType" onchange="toggleScheduleInput()">
                                        <option value="cron">Cron表达式</option>
                                        <option value="interval">时间间隔</option>
                                    </select>
                                </div>
                                
                                <!-- Cron表达式设置 -->
                                <div id="cronInputGroup" class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-calendar3 me-2"></i>执行时间
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <select class="form-select" id="cronHour">
                                                <option value="*">每小时</option>
                                                <option value="0">0点</option>
                                                <option value="1">1点</option>
                                                <option value="2">2点</option>
                                                <option value="3">3点</option>
                                                <option value="4">4点</option>
                                                <option value="5">5点</option>
                                                <option value="6">6点</option>
                                                <option value="7">7点</option>
                                                <option value="8">8点</option>
                                                <option value="9">9点</option>
                                                <option value="10">10点</option>
                                                <option value="11">11点</option>
                                                <option value="12">12点</option>
                                                <option value="13">13点</option>
                                                <option value="14">14点</option>
                                                <option value="15">15点</option>
                                                <option value="16">16点</option>
                                                <option value="17">17点</option>
                                                <option value="18">18点</option>
                                                <option value="19">19点</option>
                                                <option value="20">20点</option>
                                                <option value="21">21点</option>
                                                <option value="22">22点</option>
                                                <option value="23">23点</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <select class="form-select" id="cronMinute">
                                                <option value="0">整点</option>
                                                <option value="30">30分</option>
                                                <option value="15">15分</option>
                                                <option value="45">45分</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label">
                                            <i class="bi bi-calendar-week me-2"></i>执行周期
                                        </label>
                                        <div class="btn-group w-100 flex-wrap" role="group">
                                            <input type="checkbox" class="btn-check" id="cronWeekday1" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday1">一</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday2" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday2">二</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday3" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday3">三</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday4" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday4">四</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday5" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday5">五</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday6" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday6">六</label>
                                            
                                            <input type="checkbox" class="btn-check" id="cronWeekday7" autocomplete="off">
                                            <label class="btn btn-outline-primary flex-fill" for="cronWeekday7">日</label>
                                        </div>
                                    </div>
                                    <!-- 添加隐藏的cron表达式输入框 -->
                                    <input type="hidden" id="cronExpression" value="">
                                </div>
                                
                                <!-- 时间间隔设置 -->
                                <div id="intervalInputGroup" class="mb-3" style="display: none;">
                                    <label class="form-label">
                                        <i class="bi bi-hourglass-split me-2"></i>间隔时间
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="intervalValue" 
                                               min="1" step="1" placeholder="输入数值">
                                        <select class="form-select" id="intervalUnit" style="max-width: 120px;">
                                            <option value="60">分钟</option>
                                            <option value="3600">小时</option>
                                            <option value="86400">天</option>
                                        </select>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        常用间隔：
                                        <div class="btn-group mt-1">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setInterval(30, '60')">30分钟</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setInterval(1, '3600')">1小时</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setInterval(2, '3600')">2小时</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setInterval(24, '3600')">1天</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 预览 -->
                                <div class="mt-3">
                                    <label class="form-label">
                                        <i class="bi bi-eye me-2"></i>执行时间预览
                                    </label>
                                    <div id="schedulePreview" class="form-control">
                                        请选择定时类型和设置
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在页面中添加隐藏的配置数据 -->
    <script id="config_data" type="application/json">
        {{ config_json|safe }}
    </script>

    <script>
        // 护眼模式切换
        function toggleDarkMode() {
            document.body.setAttribute('data-bs-theme', 
                document.body.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark');
        }

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // 页面加载时初始化所有配置数据
        document.addEventListener('DOMContentLoaded', function() {
            // 获取最新的配置数据
            fetch('/get_all_configs')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 更新所有配置项
                        updateAllConfigs(data.configs);
                        
                        // 更新任务列表
                        const tasksInput = document.getElementById('TASKS');
                        if (tasksInput && data.tasks) {
                            tasksInput.value = JSON.stringify(data.tasks);
                            updateTaskList();
                        }
                    } else {
                        console.error('获取配置数据失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('获取配置数据请求失败:', error);
                    // 如果请求失败，使用页面加载时的初始数据
                    const tasksInput = document.getElementById('TASKS');
                    if (tasksInput) {
                        updateTaskList();
                    }
                });
            
            // 获取保存按钮
            const saveButton = document.getElementById('saveButton');
            
            // 添加点击事件监听器
            saveButton.addEventListener('click', function() {
                const mainForm = document.getElementById('configForm');
                const otherForm = document.getElementById('otherConfigForm');
                const config = {};
                
                // 获取所有表单数据
                const formData = new FormData(mainForm);
                
                // 处理表单数据
                for (let [key, value] of formData.entries()) {
                    processFormValue(config, key, value);
                }
                
                if (otherForm) {
                    const otherFormData = new FormData(otherForm);
                    for (let [key, value] of otherFormData.entries()) {
                        processFormValue(config, key, value);
                    }
                }

                // 特别处理任务数据 - 确保直接从隐藏字段获取
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput) {
                    try {
                        const tasksValue = tasksInput.value;
                        if (tasksValue) {
                            // 解析为JSON对象并添加到配置中
                            config['TASKS'] = JSON.parse(tasksValue);
                        }
                    } catch (e) {
                        // 出错时使用空数组
                        config['TASKS'] = [];
                    }
                }

                // 特别检查温度值
                const temperatureSlider = document.getElementById('TEMPERATURE_slider');
                const temperatureInput = document.getElementById('TEMPERATURE');
                if (temperatureSlider && temperatureInput) {
                    const tempValue = parseFloat(temperatureSlider.value);
                    if (!isNaN(tempValue)) {
                        config['TEMPERATURE'] = tempValue;
                    }
                }
                
                // 检查页面上是否有用户列表元素
                const userListElement = document.getElementById('selected_users_LISTEN_LIST');
                const hasUsers = userListElement && userListElement.querySelectorAll('.list-group-item').length > 0;
                
                // 获取人设选择
                const avatarDirSelect = document.querySelector('select[name="AVATAR_DIR"]');
                let avatarPath = '';
                let avatarName = '';
                
                if (avatarDirSelect && avatarDirSelect.value) {
                    avatarPath = avatarDirSelect.value;
                    // 从路径中提取人设名称
                    avatarName = avatarPath.split('/').pop();
                }
                
                // 根据是否有用户和人设选择决定是否显示确认对话框
                if (!hasUsers) {
                    // 创建确认对话框
                    const confirmDialog = new bootstrap.Modal(document.getElementById('emptyListenListModal'));
                    confirmDialog.show();
                    
                    // 设置确认按钮的事件
                    document.getElementById('confirmSaveBtn').onclick = function() {
                        confirmDialog.hide();
                        
                        // 检查人设选择
                        if (avatarPath) {
                            // 显示人设提醒对话框
                            document.getElementById('selectedAvatarName').textContent = avatarName;
                            const avatarDialog = new bootstrap.Modal(document.getElementById('avatarReminderModal'));
                            avatarDialog.show();
                            
                            // 设置确认按钮的事件
                            document.getElementById('confirmAvatarBtn').onclick = function() {
                                avatarDialog.hide();
                                saveConfig(config);
                            };
                        } else {
                            saveConfig(config);
                        }
                    };
                } else if (avatarPath) {
                    // 直接显示人设提醒对话框
                    document.getElementById('selectedAvatarName').textContent = avatarName;
                    const avatarDialog = new bootstrap.Modal(document.getElementById('avatarReminderModal'));
                    avatarDialog.show();
                    
                    // 设置确认按钮的事件
                    document.getElementById('confirmAvatarBtn').onclick = function() {
                        avatarDialog.hide();
                        saveConfig(config);
                    };
                } else {
                    // 直接保存配置
                    saveConfig(config);
                }
            });

            // 初始化背景
            fetch('/get_background')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.path) {
                        document.body.style.backgroundImage = `url('${data.path}')`;
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // 更新所有配置项的函数
        function updateAllConfigs(configs) {
            // 遍历所有配置组和配置项
            for (const groupKey in configs) {
                const group = configs[groupKey];
                for (const configKey in group) {
                    const config = group[configKey];
                    const element = document.getElementById(configKey);
                    if (element) {
                        // 获取实际值，即使配置结构发生变化也能获取
                        const value = config.value !== undefined ? config.value : 
                                     (config.default !== undefined ? config.default : config);
                        
                        // 根据元素类型设置值
                        if (element.type === 'checkbox') {
                            element.checked = value;
                        } else if (element.tagName === 'SELECT') {
                            element.value = value;
                        } else {
                            element.value = value;
                        }
                        
                        // 特殊处理滑块
                        const slider = document.getElementById(`${configKey}_slider`);
                        if (slider) {
                            slider.value = value;
                            const display = document.getElementById(`${configKey}_display`);
                            if (display) {
                                display.textContent = typeof value === 'number' ? 
                                    (configKey === 'TEMPERATURE' ? value.toFixed(1) : value) : 
                                    value;
                            }
                        }
                        
                        // 特殊处理视觉模型
                        if (configKey === 'VISION_MODEL') {
                            const apiSelect = document.getElementById('vision_api_provider_select');
                            const customModelInput = document.getElementById('customVisionModelInput');
                            const modelSelect = document.getElementById('vision_model_select');
                            
                            // 如果是自定义API提供商，确保自定义模型输入框显示值
                            if (apiSelect && apiSelect.value === 'custom' && value) {
                                // 显示自定义输入框并设置值
                                if (customModelInput) {
                                    customModelInput.style.display = 'block';
                                    customModelInput.querySelector('input').value = value;
                                }
                                
                                // 设置下拉框为自定义选项
                                if (modelSelect) {
                                    // 确保有自定义选项
                                    if (!modelSelect.querySelector('option[value="custom"]')) {
                                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                                    }
                                    modelSelect.value = 'custom';
                                }
                            }
                            // 常规模型选项
                            else if (modelSelect && value) {
                                // 检查是否为预设模型
                                let found = false;
                                for (let i = 0; i < modelSelect.options.length; i++) {
                                    if (modelSelect.options[i].value === value) {
                                        modelSelect.value = value;
                                        found = true;
                                        break;
                                    }
                                }
                                
                                // 如果不是预设模型，可能是自定义值
                                if (!found && value) {
                                    // 添加自定义选项
                                    if (!modelSelect.querySelector('option[value="custom"]')) {
                                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                                    }
                                    modelSelect.value = 'custom';
                                    
                                    // 显示自定义输入框
                                    if (customModelInput) {
                                        customModelInput.style.display = 'block';
                                        customModelInput.querySelector('input').value = value;
                                    }
                                }
                            }
                        }
                        
                        // 特殊处理用户列表
                        if (configKey === 'LISTEN_LIST' && Array.isArray(value)) {
                            const userListElement = document.getElementById(`selected_users_${configKey}`);
                            if (userListElement) {
                                userListElement.innerHTML = '';
                                value.forEach(user => {
                                    if (user) {
                                        const userDiv = document.createElement('div');
                                        userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                                        userDiv.innerHTML = `
                                            ${user}
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${configKey}', '${user}')">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        `;
                                        userListElement.appendChild(userDiv);
                                    }
                                });
                            }
                        }
                        
                        // 特殊处理图像识别API配置
                        if (configKey === 'VISION_BASE_URL') {
                            // 触发BASE_URL选择器更新
                            const apiSelect = document.getElementById('vision_api_provider_select');
                            if (apiSelect) {
                                // 根据值查找匹配的选项
                                let found = false;
                                for (let i = 0; i < apiSelect.options.length; i++) {
                                    const option = apiSelect.options[i];
                                    if (option.dataset.url === value) {
                                        apiSelect.value = option.value;
                                        updateVisionApiProvider(option.value);
                                        found = true;
                                        break;
                                    }
                                }
                                
                                // 如果没有找到匹配项，使用自定义选项
                                if (!found && value) {
                                    apiSelect.value = 'custom';
                                    if (typeof showCustomVisionApiInput === 'function') {
                                        showCustomVisionApiInput(value);
                                    }
                                    if (typeof updateVisionModelSelect === 'function') {
                                        updateVisionModelSelect('custom');
                                    }
                                }
                            }
                        }
                        // 特殊处理DEEPSEEK API配置
                        else if (configKey === 'DEEPSEEK_BASE_URL') {
                            // 触发API提供商选择器更新
                            const apiSelect = document.getElementById('api_provider_select');
                            if (apiSelect) {
                                // 根据值查找匹配的选项
                                let found = false;
                                for (let i = 0; i < apiSelect.options.length; i++) {
                                    const option = apiSelect.options[i];
                                    if (option.dataset.url === value) {
                                        apiSelect.value = option.value;
                                        updateApiProvider(option.value);
                                        found = true;
                                        break;
                                    }
                                }
                                
                                // 如果没有找到匹配项，使用自定义选项
                                if (!found && value) {
                                    apiSelect.value = 'custom';
                                    showCustomApiInput(value);
                                    updateModelSelect('custom');
                                }
                            }
                        }
                        else if (configKey === 'VISION_MODEL') {
                            // 尝试更新模型选择器
                            const modelSelect = document.getElementById('vision_model_select');
                            const customModelInput = document.getElementById('customVisionModelInput');
                            const apiSelect = document.getElementById('vision_api_provider_select');
                            
                            if (modelSelect && value) {
                                // 检查是否为预设选项
                                let option = modelSelect.querySelector(`option[value="${value}"]`);
                                
                                if (option) {
                                    // 如果是预设选项，直接选择
                                    modelSelect.value = value;
                                } else {
                                    // 如果不是预设选项，可能是自定义模型
                                    // 确保有自定义选项
                                    if (!modelSelect.querySelector('option[value="custom"]')) {
                                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                                    }
                                    
                                    // 设置为自定义选项
                                    modelSelect.value = 'custom';
                                    
                                    // 显示自定义输入框
                                    if (customModelInput) {
                                        customModelInput.style.display = 'block';
                                        customModelInput.querySelector('input').value = value;
                                    }
                                }
                            }
                        }
                        // 特殊处理LLM模型
                        else if (configKey === 'MODEL') {
                            // 尝试更新LLM模型选择器
                            const modelSelect = document.getElementById('model_select');
                            const customModelInput = document.getElementById('customModelInput');
                            const apiSelect = document.getElementById('api_provider_select');
                            
                            if (modelSelect && value) {
                                // 检查是否为预设选项
                                let option = modelSelect.querySelector(`option[value="${value}"]`);
                                
                                if (option) {
                                    // 如果是预设选项，直接选择
                                    modelSelect.value = value;
                                } else {
                                    // 如果不是预设选项，可能是自定义模型
                                    // 确保有自定义选项
                                    if (!modelSelect.querySelector('option[value="custom"]')) {
                                        modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
                                    }
                                    
                                    // 设置为自定义选项
                                    modelSelect.value = 'custom';
                                    
                                    // 显示自定义输入框
                                    if (customModelInput) {
                                        customModelInput.style.display = 'block';
                                        customModelInput.querySelector('input').value = value;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // 保存配置的函数
        function saveConfig(config) {
            // 在发送前进行最终数据格式检查
            for (const key in config) {
                // 确保列表类型的数据是数组而非字符串
                if (key === 'LISTEN_LIST' && typeof config[key] === 'string') {
                    config[key] = config[key].split(',')
                        .map(item => item.trim())
                        .filter(item => item);
                }
                // 确保数字类型的数据是数字而非字符串
                else if (['MAX_TOKEN', 'TEMPERATURE', 'VISION_TEMPERATURE', 
                          'MIN_COUNTDOWN_HOURS', 'MAX_COUNTDOWN_HOURS', 'MAX_GROUPS'].includes(key)) {
                    const numValue = parseFloat(config[key]);
                    if (!isNaN(numValue)) {
                        config[key] = numValue;
                        // 对于整数类型配置，转为整数
                        if (['MAX_TOKEN', 'MAX_GROUPS'].includes(key)) {
                            config[key] = Math.round(numValue);
                        }
                    }
                }
            }
            
            // 确保API相关配置被正确保存
            const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
            const modelInput = document.getElementById('MODEL');
            const apiKeyInput = document.getElementById('DEEPSEEK_API_KEY');
            
            if (baseUrlInput) {
                config['DEEPSEEK_BASE_URL'] = baseUrlInput.value;
            }
            if (modelInput) {
                config['MODEL'] = modelInput.value;
            }
            if (apiKeyInput) {
                config['DEEPSEEK_API_KEY'] = apiKeyInput.value;
            }
            
            // 直接发送简单的键值对配置，而不是嵌套结构
            console.log("发送配置数据:", config);
            
            // 发送保存请求
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showSaveNotification(data.message);
                } else {
                    showSaveNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                showSaveNotification('保存配置失败: ' + error.message, 'error');
            });
        }

        function processFormValue(config, key, value) {
            // 处理列表类型
            if (key === 'LISTEN_LIST') {
                // 直接保存为字符串，在最终提交前再转换为数组
                config[key] = value;
            } 
            // 处理数字类型
            else if (['TEMPERATURE', 'VISION_TEMPERATURE', 'MAX_TOKEN', 
                     'MIN_COUNTDOWN_HOURS', 'MAX_COUNTDOWN_HOURS', 'MAX_GROUPS'].includes(key)) {
                // 转换为数字类型
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    config[key] = numValue;
                    // 整数类型配置转为整数
                    if (['MAX_TOKEN', 'MAX_GROUPS'].includes(key)) {
                        config[key] = Math.round(numValue);
                    }
                } else {
                    config[key] = value; // 如果无法转换，保留原值
                }
            }
            // 处理任务配置
            else if (key === 'TASKS') {
                try {
                    config[key] = JSON.parse(value);
                } catch (e) {
                    console.error("解析任务数据失败:", e);
                    config[key] = [];
                }
            } 
            // 处理布尔值
            else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                config[key] = value.toLowerCase() === 'true';
            } 
            // 其他类型直接保存
            else {
                config[key] = value;
            }
        }

        // 添加新函数
        function addToListFromSelect(key, value) {
            if (value === 'add_new') {
                document.getElementById('new_input_' + key).style.display = 'flex';
                setTimeout(() => {
                    document.querySelector(`select[onchange*="${key}"]`).value = '';
                }, 100);
                return;
            }
            
            if (value) {
                const targetElement = document.getElementById(key);
                const currentValues = targetElement.value ? targetElement.value.split(',') : [];
                if (!currentValues.includes(value)) {
                    currentValues.push(value);
                    targetElement.value = currentValues.join(',');
                    
                    // 添加到用户列表显示
                    const userListElement = document.getElementById('selected_users_' + key);
                    const userDiv = document.createElement('div');
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${value}
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${key}', '${value}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild(userDiv);
                }
            }
        }

        function addNewUser(key) {
            const inputElement = document.getElementById('input_' + key);
            const newValue = inputElement.value.trim();
            
            if (newValue) {
                const targetElement = document.getElementById(key);
                const currentValues = targetElement.value ? targetElement.value.split(',') : [];
                if (!currentValues.includes(newValue)) {
                    currentValues.push(newValue);
                    targetElement.value = currentValues.join(',');
                    
                    // 添加到用户列表显示
                    const userListElement = document.getElementById('selected_users_' + key);
                    const userDiv = document.createElement('div');
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${newValue}
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${key}', '${newValue}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild(userDiv);
                    
                    // 清空输入框
                    inputElement.value = '';
                }
            }
            updateTaskChatIdOptions();
        }

        function removeUser(key, userToRemove) {
            const targetElement = document.getElementById(key);
            const userListElement = document.getElementById('selected_users_' + key);
            
            // 更新隐藏的input值
            let currentValues = targetElement.value ? targetElement.value.split(',') : [];
            currentValues = currentValues.filter(user => user !== userToRemove);
            targetElement.value = currentValues.join(',');
            
            // 从显示列表中移除
            const userElements = userListElement.getElementsByClassName('list-group-item');
            for (let element of userElements) {
                if (element.textContent.trim() === userToRemove) {
                    element.remove();
                    break;
                }
            }
            updateTaskChatIdOptions();
        }

        // 添加背景图片上传处理
        document.getElementById('backgroundInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('background', file);
                
                fetch('/upload_background', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.body.style.backgroundImage = `url('${data.path}')`;
                        showToast(data.message, 'success');
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showToast('上传失败：' + error, 'danger');
                });
            }
        });

        function showSaveNotification(message, type = 'success') {
            const notification = document.getElementById('saveNotification');
            const messageElement = document.getElementById('saveNotificationMessage');
            
            // 移除现有的背景色类
            notification.classList.remove('bg-success', 'bg-danger');
            
            // 根据类型设置样式
            if (type === 'success') {
                notification.classList.add('bg-success');
            } else {
                notification.classList.add('bg-danger');
            }
            
            messageElement.textContent = message;
            
            const toast = new bootstrap.Toast(notification, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            toast.show();
        }

        // 添加设置时间间隔的辅助函数
        function setInterval(value, unit) {
            document.getElementById('intervalValue').value = value;
            document.getElementById('intervalUnit').value = unit;
            updateSchedulePreview();
        }

        // 修改更新预览的函数
        function updateSchedulePreview() {
            const scheduleType = document.getElementById('scheduleType').value;
            const preview = document.getElementById('schedulePreview');
            
            if (scheduleType === 'cron') {
                const hour = document.getElementById('cronHour').value;
                const minute = document.getElementById('cronMinute').value;
                const weekdays = [];
                
                // 获取选中的星期
                for (let i = 1; i <= 7; i++) {
                    if (document.getElementById(`cronWeekday${i}`).checked) {
                        // 将1-7转换为0-6（0代表周日）
                        weekdays.push(i === 7 ? 0 : i - 1);
                    }
                }
                
                if (weekdays.length === 0) {
                    preview.textContent = '请选择执行周期';
                    return;
                }
                
                let previewText = `每天 ${hour === '*' ? '每小时' : hour + '点'} ${minute}分`;
                if (weekdays.length < 7) {
                    previewText = `每周 ${weekdays.map(w => ['日', '一', '二', '三', '四', '五', '六'][w]).join('、')} ${hour === '*' ? '每小时' : hour + '点'} ${minute}分`;
                }
                
                preview.textContent = previewText;
                
                // 更新cron表达式 - 修改为5字段格式
                const cronExp = `${minute} ${hour} * * ${weekdays.join(',')}`;
                document.getElementById('cronExpression').value = cronExp;
            } else {
                const value = document.getElementById('intervalValue').value;
                const unit = document.getElementById('intervalUnit').value;
                
                if (!value) {
                    preview.textContent = '请设置间隔时间';
                    return;
                }
                
                let unitText = '';
                switch(unit) {
                    case '60': unitText = '分钟'; break;
                    case '3600': unitText = '小时'; break;
                    case '86400': unitText = '天'; break;
                }
                
                preview.textContent = `每 ${value} ${unitText}`;
            }
        }

        // 修改格式化Cron表达式的函数
        function formatCronExpression(cronExp) {
            const [minute, hour, day, month, weekday] = cronExp.split(' ');
            let result = '';
            
            // 处理星期
            if (weekday !== '*') {
                const weekdays = weekday.split(',').map(w => ['日', '一', '二', '三', '四', '五', '六'][parseInt(w)]);
                result += `每周${weekdays.join('、')} `;
            } else {
                result += '每天 ';
            }
            
            // 处理时间
            if (hour === '*') {
                result += `每小时${minute}分`;
            } else {
                result += `${hour}点${minute}分`;
            }
            
            return result;
        }

        // 修改切换调度类型输入框的函数
        function toggleScheduleInput() {
            const scheduleType = document.getElementById('scheduleType').value;
            const cronInput = document.getElementById('cronInputGroup');
            const intervalInput = document.getElementById('intervalInputGroup');
            
            if (scheduleType === 'cron') {
                cronInput.style.display = 'block';
                intervalInput.style.display = 'none';
            } else {
                cronInput.style.display = 'none';
                intervalInput.style.display = 'block';
            }
            
            updateSchedulePreview();
        }

        // 为所有相关输入添加change事件监听
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [
                'cronHour', 'cronMinute',
                'cronWeekday1', 'cronWeekday2', 'cronWeekday3',
                'cronWeekday4', 'cronWeekday5', 'cronWeekday6', 'cronWeekday7',
                'intervalValue', 'intervalUnit'
            ];
            
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateSchedulePreview);
                }
            });
        });

        // 修改保存任务的函数
        function saveTask() {
            const taskId = document.getElementById('taskId').value.trim();
            const chatId = document.getElementById('taskChatId').value;
            const content = document.getElementById('taskContent').value.trim();
            const scheduleType = document.getElementById('scheduleType').value;
            
            // 验证必填字段
            if (!taskId || !chatId || !content) {
                showSaveNotification('请填写所有必填字段', 'error');
                return;
            }
            
            const task = {
                task_id: taskId,
                chat_id: chatId,
                content: content,
                schedule_type: scheduleType,
                is_active: true
            };
            
            // 根据调度类型设置相应的值
            if (scheduleType === 'cron') {
                const cronExp = document.getElementById('cronExpression').value;
                if (!cronExp) {
                    showSaveNotification('请设置执行时间', 'error');
                    return;
                }
                // 验证cron表达式格式
                const [minute, hour, day, month, weekday] = cronExp.split(' ');
                if (!/^\d+$/.test(minute) || !/^\d+$/.test(hour) || !/^[\d,]+$/.test(weekday)) {
                    showSaveNotification('Cron表达式格式不正确', 'error');
                    return;
                }
                task.schedule_time = cronExp;
            } else {
                const value = document.getElementById('intervalValue').value;
                const unit = document.getElementById('intervalUnit').value;
                
                if (!value) {
                    showSaveNotification('请设置间隔时间', 'error');
                    return;
                }
                
                // 计算总秒数
                const totalSeconds = parseInt(value) * parseInt(unit);
                task.schedule_time = totalSeconds.toString();
                task.interval = totalSeconds.toString();
            }
            
            // 获取现有的任务列表
            let tasks = [];
            try {
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput && tasksInput.value) {
                    tasks = JSON.parse(tasksInput.value);
                }
            } catch (e) {
                console.error('解析任务列表失败:', e);
            }
            
            // 更新任务列表
            const existingIndex = tasks.findIndex(t => t.task_id === taskId);
            if (existingIndex >= 0) {
                tasks[existingIndex] = task;
            } else {
                tasks.push(task);
            }
            
            // 更新隐藏输入框的值
            document.getElementById('TASKS').value = JSON.stringify(tasks);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            modal.hide();
            
            // 显示成功提示
            showSaveNotification('任务已添加，请点击底部的"保存所有设置"按钮保存更改');
            
            // 刷新任务列表
            updateTaskList();
        }

        // 修改更新任务列表的函数
        function updateTaskList() {
            const container = document.getElementById('taskListContainer');
            if (!container) return;
            
            // 获取任务列表
            let tasks = [];
            try {
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput && tasksInput.value) {
                    tasks = JSON.parse(tasksInput.value);
                }
            } catch (e) {
                console.error('解析任务列表失败:', e);
            }
            
            // 更新显示
            container.innerHTML = tasks.length === 0 ? `
                <div class="text-center text-muted p-4">
                    <i class="bi bi-inbox fs-2"></i>
                    <p class="mt-2">暂无定时任务</p>
                </div>
            ` : tasks.map(task => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-auto">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-primary me-2">${task.task_id}</span>
                                <span class="badge ${task.is_active ? 'bg-success' : 'bg-secondary'} me-2">
                                    ${task.is_active ? '运行中' : '已暂停'}
                                </span>
                            </div>
                            <div class="mb-1">
                                <i class="bi bi-person me-1"></i>发送给：${task.chat_id}
                            </div>
                            <div class="mb-1">
                                <i class="bi bi-clock me-1"></i>执行时间：
                                ${task.schedule_type === 'cron' ? 
                                    formatCronExpression(task.schedule_time) : 
                                    formatInterval(task.schedule_time)}
                            </div>
                            <div class="text-muted small">
                                <i class="bi bi-chat-text me-1"></i>${task.content}
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleTask('${task.task_id}')" title="${task.is_active ? '暂停任务' : '启动任务'}">
                                <i class="bi bi-${task.is_active ? 'pause' : 'play'}-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${task.task_id}')" title="删除任务">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 添加格式化时间间隔的函数
        function formatInterval(seconds) {
            const hours = parseInt(seconds) / 3600;
            if (hours >= 24) {
                return `每${hours/24}天`;
            } else if (hours >= 1) {
                return `每${hours}小时`;
            } else {
                return `每${hours*60}分钟`;
            }
        }

        // 添加切换任务状态的函数
        function toggleTask(taskId) {
            let tasks = [];
            try {
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput && tasksInput.value) {
                    tasks = JSON.parse(tasksInput.value);
                }
            } catch (e) {
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.task_id === taskId);
            if (taskIndex >= 0) {
                tasks[taskIndex].is_active = !tasks[taskIndex].is_active;
                document.getElementById('TASKS').value = JSON.stringify(tasks);
                updateTaskList();
                showSaveNotification(`任务已${tasks[taskIndex].is_active ? '启动' : '暂停'}，请点击底部的"保存所有设置"按钮保存更改`);
            }
        }

        // 添加更新发送对象下拉框的函数
        function updateTaskChatIdOptions() {
            const chatSelect = document.getElementById('taskChatId');
            if (!chatSelect) return;
            
            // 保存当前选中的值
            const currentValue = chatSelect.value;
            
            // 清空现有选项
            chatSelect.innerHTML = '<option value="">请选择发送对象</option>';
            
            // 从监听列表获取用户
            const userElements = document.querySelectorAll('#selected_users_LISTEN_LIST .list-group-item');
            userElements.forEach(element => {
                const userName = element.textContent.trim().replace('×', '').trim();
                if (userName) {
                    chatSelect.innerHTML += `<option value="${userName}">${userName}</option>`;
                }
            });
            
            // 恢复之前选中的值
            if (currentValue) {
                chatSelect.value = currentValue;
            }
        }

        // 修改显示添加任务模态框时的处理
        document.getElementById('addTaskModal').addEventListener('show.bs.modal', function () {
            // 重置表单
            document.getElementById('taskForm').reset();
            
            // 更新发送对象下拉框
            updateTaskChatIdOptions();
            
            // 默认显示cron输入框
            toggleScheduleInput();
        });

        // 在用户列表变化时更新发送对象下拉框
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有温度滑块
            const temperatureSliders = document.querySelectorAll('[id$="_slider"].temperature-slider');
            temperatureSliders.forEach(slider => {
                const key = slider.id.replace('_slider', '');
                updateTemperature(key, slider.value);
            });
            
            // 监听用户列表的变化
            const userListElement = document.getElementById('selected_users_LISTEN_LIST');
            if (userListElement) {
                const observer = new MutationObserver(function(mutations) {
                    updateTaskChatIdOptions();
                });
                
                observer.observe(userListElement, {
                    childList: true,
                    subtree: true
                });
            }
            
            // 初始化时更新一次
            updateTaskChatIdOptions();
        });

        // 添加删除任务的函数
        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？')) {
                // 获取当前任务列表
                let tasks = [];
                try {
                    const tasksInput = document.getElementById('TASKS');
                    if (tasksInput && tasksInput.value) {
                        tasks = JSON.parse(tasksInput.value);
                    }
                } catch (e) {
                    return;
                }
                
                // 删除指定任务
                tasks = tasks.filter(t => t.task_id !== taskId);
                
                // 更新隐藏输入框的值
                document.getElementById('TASKS').value = JSON.stringify(tasks);
                
                // 刷新任务列表显示
                updateTaskList();
                
                showSaveNotification('任务已删除，请点击底部的"保存所有设置"按钮保存更改');
            }
        }

        // 添加页面关闭事件监听器
        window.addEventListener('beforeunload', function(e) {
            // 获取所有配置数据
            const mainForm = document.getElementById('configForm');
            const otherForm = document.getElementById('otherConfigForm');
            const config = {};
            
            // 获取所有表单数据
            const formData = new FormData(mainForm);
            
            // 处理表单数据
            for (let [key, value] of formData.entries()) {
                processFormValue(config, key, value);
            }
            
            if (otherForm) {
                const otherFormData = new FormData(otherForm);
                for (let [key, value] of otherFormData.entries()) {
                    processFormValue(config, key, value);
                }
            }

            // 特别处理任务数据
            const tasksInput = document.getElementById('TASKS');
            if (tasksInput) {
                try {
                    const tasksValue = tasksInput.value;
                    if (tasksValue) {
                        config['TASKS'] = JSON.parse(tasksValue);
                    }
                } catch (e) {
                    config['TASKS'] = [];
                }
            }

            // 特别检查温度值
            const temperatureSlider = document.getElementById('TEMPERATURE_slider');
            const temperatureInput = document.getElementById('TEMPERATURE');
            if (temperatureSlider && temperatureInput) {
                const tempValue = parseFloat(temperatureSlider.value);
                if (!isNaN(tempValue)) {
                    config['TEMPERATURE'] = tempValue;
                }
            }

            // 使用 navigator.sendBeacon 发送保存请求
            // 这种方式可以在页面关闭时可靠地发送数据
            const data = new FormData();
            data.append('config', JSON.stringify(config));
            
            // 发送保存请求
            navigator.sendBeacon('/save', data);
        });

        // 导出配置按钮事件监听
        document.getElementById('exportConfigBtn').addEventListener('click', function() {
            // 收集所有配置数据
            const mainForm = document.getElementById('configForm');
            const otherForm = document.getElementById('otherConfigForm');
            const config = {};
            
            // 获取所有表单数据
            const formData = new FormData(mainForm);
            for (let [key, value] of formData.entries()) {
                processFormValue(config, key, value);
            }
            
            if (otherForm) {
                const otherFormData = new FormData(otherForm);
                for (let [key, value] of otherFormData.entries()) {
                    processFormValue(config, key, value);
                }
            }

            // 特别处理任务数据
            const tasksInput = document.getElementById('TASKS');
            if (tasksInput) {
                try {
                    const tasksValue = tasksInput.value;
                    if (tasksValue) {
                        config['TASKS'] = JSON.parse(tasksValue);
                    }
                } catch (e) {
                    config['TASKS'] = [];
                }
            }

            // 创建JSON文件并下载
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            const filename = `KouriChat_配置_${dateStr}.json`;
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = filename;
            
            // 模拟点击下载
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // 显示成功通知
            showSaveNotification('配置已成功导出', 'success');
        });

        // 导入配置按钮事件监听
        document.getElementById('importConfigBtn').addEventListener('click', function() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'application/json';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length === 0) return;
                
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        // 填充表单数据
                        for (const [key, value] of Object.entries(config)) {
                            if (key === 'TASKS') {
                                // 特殊处理任务数据
                                const tasksInput = document.getElementById('TASKS');
                                if (tasksInput) {
                                    tasksInput.value = JSON.stringify(value);
                                    // 刷新任务列表显示
                                    if (typeof refreshTaskList === 'function') {
                                        refreshTaskList();
                                    }
                                }
                                continue;
                            }
                            
                            // 处理普通输入字段
                            const input = document.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = Boolean(value);
                                } else {
                                    input.value = value;
                                }
                                
                                // 特别处理滑块
                                if (key === 'TEMPERATURE' || key === 'VISION_TEMPERATURE') {
                                    const slider = document.getElementById(`${key}_slider`);
                                    if (slider) {
                                        slider.value = value;
                                        // 使用统一的updateTemperature函数更新显示
                                        updateTemperature(key, value);
                                    }
                                }
                            }
                        }
                        
                        showSaveNotification('配置已成功导入', 'success');
                    } catch (error) {
                        console.error('导入配置失败:', error);
                        showSaveNotification('导入配置失败: ' + error.message, 'danger');
                    }
                };
                
                reader.readAsText(file);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        });

        // 添加任务相关函数
        function loadTasks() {
            fetch('/get_tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 更新隐藏的input字段
                        document.getElementById('TASKS').value = JSON.stringify(data.tasks);
                        
                        // 更新任务列表显示
                        updateTaskListUI(data.tasks);
                        
                        // 更新发送对象下拉选项
                        updateTaskChatIdOptions();
                    } else {
                        showToast('加载任务失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('加载任务失败: ' + error, 'error');
                });
        }

        function updateTaskListUI(tasks) {
            const container = document.getElementById('taskListContainer');
            
            if (tasks && tasks.length > 0) {
                // 清空现有内容
                container.innerHTML = '';
                
                // 添加每个任务
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'list-group-item';
                    
                    let scheduleInfo = '';
                    if (task.schedule_type === 'cron') {
                        scheduleInfo = `<span class="badge bg-primary me-1">Cron</span> ${task.schedule_time}`;
                    } else {
                        scheduleInfo = `<span class="badge bg-success me-1">间隔</span> ${task.schedule_time}`;
                    }
                    
                    taskItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${task.task_id}</h5>
                            <small>
                                ${scheduleInfo}
                                <span class="badge ${task.is_active ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${task.is_active ? '启用' : '禁用'}
                                </span>
                            </small>
                        </div>
                        <p class="mb-1">发送给: ${task.chat_id}</p>
                        <p class="mb-1">内容: ${task.content}</p>
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editTask('${task.task_id}')">
                                <i class="bi bi-pencil"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteTask('${task.task_id}')">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(taskItem);
                });
            } else {
                // 显示无任务提示
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-inbox fs-2"></i>
                        <p class="mt-2">暂无定时任务</p>
                    </div>
                `;
            }
        }

        function saveTask() {
            // 获取表单数据
            const taskId = document.getElementById('taskId').value.trim();
            const chatId = document.getElementById('taskChatId').value;
            const content = document.getElementById('taskContent').value.trim();
            const scheduleType = document.getElementById('scheduleType').value;
            let scheduleTime = '';
            
            // 根据任务类型获取调度时间
            if (scheduleType === 'cron') {
                scheduleTime = document.getElementById('cronExpression').value.trim();
            } else {
                const intervalValue = document.getElementById('intervalValue').value.trim();
                const intervalUnit = document.getElementById('intervalUnit').value;
                scheduleTime = `${intervalValue}${intervalUnit}`;
            }
            
            // 验证表单
            if (!taskId || !chatId || !content || !scheduleTime) {
                showToast('请填写所有必要字段', 'error');
                return;
            }
            
            // 创建任务对象
            const task = {
                task_id: taskId,
                chat_id: chatId,
                content: content,
                schedule_type: scheduleType,
                schedule_time: scheduleTime,
                is_active: true
            };
            
            // 发送保存请求
            fetch('/save_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(task)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 隐藏模态框
                    bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
                    
                    // 重新加载任务列表
                    loadTasks();
                    
                    // 显示成功提示
                    showToast(data.message, 'success');
                    
                    // 重置表单
                    document.getElementById('taskForm').reset();
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('保存任务失败: ' + error, 'error');
            });
        }

        function confirmDeleteTask(taskId) {
            if (confirm(`确定要删除任务 "${taskId}" 吗？`)) {
                deleteTask(taskId);
            }
        }

        function deleteTask(taskId) {
            fetch('/delete_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({task_id: taskId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 重新加载任务列表
                    loadTasks();
                    
                    // 显示成功提示
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('删除任务失败: ' + error, 'error');
            });
        }

        function editTask(taskId) {
            // 获取当前任务数据
            const tasksValue = document.getElementById('TASKS').value;
            let tasks = [];
            
            try {
                tasks = JSON.parse(tasksValue);
            } catch (e) {
                showToast('解析任务数据失败', 'error');
                return;
            }
            
            // 查找指定任务
            const task = tasks.find(t => t.task_id === taskId);
            if (!task) {
                showToast('未找到指定任务', 'error');
                return;
            }
            
            // 填充表单
            document.getElementById('taskId').value = task.task_id;
            document.getElementById('taskId').readOnly = true; // 编辑模式下不允许修改ID
            document.getElementById('taskChatId').value = task.chat_id;
            document.getElementById('taskContent').value = task.content;
            document.getElementById('scheduleType').value = task.schedule_type;
            
            // 根据任务类型设置调度时间
            toggleScheduleInput(); // 先切换显示正确的输入框
            
            if (task.schedule_type === 'cron') {
                document.getElementById('cronExpression').value = task.schedule_time;
            } else {
                // 解析间隔值和单位
                const match = task.schedule_time.match(/(\d+)([smhd])/);
                if (match) {
                    document.getElementById('intervalValue').value = match[1];
                    document.getElementById('intervalUnit').value = match[2];
                }
            }
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            modal.show();
            
            // 更新模态框标题
            document.getElementById('addTaskModalLabel').innerHTML = 
                '<i class="bi bi-pencil-square me-2"></i>编辑定时任务';
            
            // 更改保存按钮文本
            const saveButton = document.querySelector('#addTaskModal .modal-footer .btn-primary');
            saveButton.textContent = '保存修改';
        }

        // 初始化任务功能
        document.addEventListener('DOMContentLoaded', function() {
            // 加载任务列表
            loadTasks();
            
            // 添加任务表单提交处理
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTask();
            });
            
            // 添加调度类型切换处理
            document.getElementById('scheduleType').addEventListener('change', toggleScheduleInput);
            
            // 初始隐藏间隔输入组
            document.getElementById('intervalInputGroup').style.display = 'none';
            
            // 添加模态框关闭事件处理
            document.getElementById('addTaskModal').addEventListener('hidden.bs.modal', function() {
                // 重置表单
                document.getElementById('taskForm').reset();
                document.getElementById('taskId').readOnly = false;
                document.getElementById('addTaskModalLabel').innerHTML = 
                    '<i class="bi bi-plus-circle me-2"></i>添加定时任务';
                
                // 重置保存按钮文本
                const saveButton = document.querySelector('#addTaskModal .modal-footer .btn-primary');
                saveButton.textContent = '保存';
                
                // 默认显示Cron输入组
                document.getElementById('cronInputGroup').style.display = 'block';
                document.getElementById('intervalInputGroup').style.display = 'none';
            });
        });
    </script>
</body>
</html>
